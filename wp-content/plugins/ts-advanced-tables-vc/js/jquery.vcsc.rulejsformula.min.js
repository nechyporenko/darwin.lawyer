!function(e){"use strict";function r(){var r=function(e){return e&&"="===e[0]?!0:!1},t=function(t,l,o,i,n,a,s){if(t.formulasEnabled&&r(a)){var f,m,p=t.plugin.utils.translateCellCoords({row:o,col:i}),g=null,c=null,v=!1;if(!p)return;var h=t.plugin.matrix.getItem(p);if(h&&(v=!!h.needUpdate,h.error&&(g=h.formula,f=h.error,v&&(f=null))),(a&&"="===a[0]||v)&&(c=a.substr(1).toUpperCase(),!f||c!==g)){var w=h;w||(h={id:p,formula:c},w=t.plugin.matrix.addItem(h));var C=t.plugin.parse(c,{row:o,col:i,id:p});v="#NEED_UPDATE"===C.error,t.plugin.matrix.updateItem(w,{formula:c,value:C.result,error:C.error,needUpdate:v}),f=C.error,m=C.result,a=f||m}f&&(a?a=f:f=null),t.plugin.utils.isSet(f)?e.Dom.addClass(l,"formula-error"):t.plugin.utils.isSet(m)&&(e.Dom.removeClass(l,"formula-error"),e.Dom.addClass(l,"formula"))}"numeric"===s.type?d.renderer.apply(this,[t,l,o,i,n,a,s]):u.renderer.apply(this,[t,l,o,i,n,a,s])},l=function(e,r){var t=this;if(t.formulasEnabled&&("edit"===r||"undo"===r||"autofill"===r)){var l=!1;e.forEach(function(e){var r=e[0],o=e[1],i=e[2],n=e[3],a=t.plugin.utils.translateCellCoords({row:r,col:o});if(""!=n&&"null"!=n&&null!=n&&"undefined"!=n&&void 0!=n&&("="!==n[0]||i!==n)){t.plugin.matrix.removeItem(a);var u=t.plugin.matrix.getDependencies(a);u.forEach(function(e){t.plugin.matrix.updateItem(e,{needUpdate:!0})}),l=!0}}),l&&t.render()}},o=function(e,r,t,l,o,i){var n=this,a=e.row,u=e.col,d=t[a][u],s=0,f=t.length,m=t?t[0].length:0;if("="===d[0])return-1!==["down","up"].indexOf(r)?s=f*o.row:-1!==["right","left"].indexOf(r)&&(s=m*o.col),{value:n.plugin.utils.updateFormula(d,r,s),iterators:o};if(f>=2||m>=2){var p,g,c=n.plugin.helper.number(d);if(n.plugin.utils.isNumber(c))return-1!==["down","up"].indexOf(r)?(s=l[0][u],"down"===r?c+=s*f*o.row:(p=(i.row-a)%f,g=p>0?f-p:0,c=n.plugin.helper.number(t[g][u]),c+=s*f*o.row,o.row>1&&g+1===f&&o.row--)):-1!==["right","left"].indexOf(r)&&(s=l[a][0],"right"===r?c+=s*m*o.col:(p=(i.col-u)%m,g=p>0?m-p:0,c=n.plugin.helper.number(t[a][g]),c+=s*m*(o.col||1),o.col>1&&g+1===m&&o.col--)),{value:c,iterators:o}}return{value:d,iterators:o}},i=function(e,r,t){if(!t){var l=this,o=l.plugin.utils.isArray(l.getSelected())?l.getSelected()[0]:void 0;if(!l.plugin.utils.isUndefined(o)){var i=o>=e?"before":"after",n=l.plugin.matrix.getRefItemsToRow(e),a=1,u=[];n.forEach(function(r){var t=l.plugin.matrix.getItem(r),n=l.plugin.utils.changeFormula(t.formula,1,{row:e}),d=r;if(n!==t.formula){("before"===i&&o<=t.row||"after"===i&&o<t.row)&&(d=l.plugin.utils.changeRowIndex(r,a));var s=l.plugin.utils.cellCoords(d);d!==r&&l.plugin.matrix.removeItem(r),u.push([s.row,s.col,"="+n])}}),n&&l.plugin.matrix.removeItemsBelowRow(e),u&&l.setDataAtCell(u)}}},n=function(e){var r=this,t=r.plugin.utils.isArray(r.getSelected())?r.getSelected()[1]:void 0;if(!r.plugin.utils.isUndefined(t)){var l=r.plugin.matrix.getRefItemsToColumn(e),o=1,i=t>=e?"before":"after",n=[];l.forEach(function(l){var a=r.plugin.matrix.getItem(l),u=r.plugin.utils.changeFormula(a.formula,1,{col:e}),d=l;if(u!==a.formula){("before"===i&&t<=a.col||"after"===i&&t<a.col)&&(d=r.plugin.utils.changeColIndex(l,o));var s=r.plugin.utils.cellCoords(d);d!==l&&r.plugin.matrix.removeItem(l),n.push([s.row,s.col,"="+u])}}),l&&r.plugin.matrix.removeItemsBelowCol(e),n&&r.setDataAtCell(n)}},a={renderer:t,editor:e.editors.TextEditor,dataType:"formula"},u={renderer:e.renderers.TextRenderer,editor:e.editors.TextEditor},d={renderer:e.renderers.NumericRenderer,editor:e.editors.NumericEditor};this.init=function(){var r=this;if(r.formulasEnabled=!!r.getSettings().formulas,r.formulasEnabled){var u={cellValue:r.getDataAtCell};r.plugin=new ruleJS,r.plugin.init(),r.plugin.custom=u,e.cellTypes.formula=a,e.TextCell.renderer=t,e.NumericCell.renderer=t,r.addHook("afterChange",l),r.addHook("beforeAutofillInsidePopulate",o),r.addHook("afterCreateRow",i),r.addHook("afterCreateCol",n)}else r.removeHook("afterChange",l),r.removeHook("beforeAutofillInsidePopulate",o),r.removeHook("afterCreateRow",i),r.removeHook("afterCreateCol",n)}}var t=new r;e.hooks.add("beforeInit",t.init),e.hooks.add("afterUpdateSettings",function(){t.init.call(this,"afterUpdateSettings")})}(Handsontable);